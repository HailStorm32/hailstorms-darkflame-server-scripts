'''                                                                               
      ▓▒██████████████████████████████████████▓▒
    █▓▒████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▒
   ▓▒███▒░░░░░░░░░░░░░░░░▒░▓░░░░░░░░░░░░░░░░███▓▒
  ▓▓███░░░░░░░░░░░░░░░░░▒▒▒░░░░░░░░░░░░░░▒▒▒░▓██▓▒
 ▓▓███░░░░░░░░░░░░░░░░░▒▒▒░░░░░░░░░░░░░░▒▒▒▒▒░▓██▓▒
 ▒███▒░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒░░░░░░▒▒▒▒▒▒▒░███▓
 ▓▒███▓░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒▒▒▒░░░░░░▒▒▒▒▒▒▒░███▓▒
  ▓▒███▓░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒░░░░░░▒▒▒▒▒▒▒░███▓▒
   ▓▒███▓░▒▒▒▒▒▒░░░░░░░░░░░█▒░░░░░░░▒▒▒▒▒▒▒░███▓▒
    ▓▒███▓░▒▒▒▒▒▒░▒▒▒▒░████▒░░░░░░░▒▒▒▒▒▒▒░███▓▒
     ▓▒███▓░▒▒▒▒▒▒░▒▒░░░▒░█▓░▒▒▒▒▒▒▒▒▒▒▒▒░███▓▒
      ▓▒███▓░▒▒▒▒▒░░░░░▒▒▒░░░░░░░░▒▒▒▒▒▒▒███▓▒
      █▓▒█████▓░░░░░░░▒▒▒▒▒░░░░░▒▒░▒▒▒░▒███▓▒
        ▓▒████░▒▒▒▒▒▒░▒▒▒▒▒▒░░░▒▒▒▒░▒▒▓███▓▓
         ▓▒████░▒▒▒▒▒▒░▒▒▒▒▒▒░▒▒▒▒▒▒░████▒▓
           ▒▓███░▒▒▒▒▒▒░▒▒▒▒▒▒▒▒▒▒▒░▒███▒▓
            ▒▓███░▒▒▒▒▒▒░▒▒▒▒▒▒▒▒▒░▓███▒▓
             ▒▓███░▒▒▒▒▒▒░▒▒▒▒▒▒▒░▓███▒▓
              ▒▓███░▒▒▒▒▒▒░▒▒▒▒▒░▓███▒▓
               ▒▓███░▒▒▒▒▒▒░▒▒▒░▓███▒▓
                ▒▓███░▒▒▒▒▒▒░▒░▓███▒▓
                 ▒▓███▒▒▒▒▒▒▒▒████▒▓
                  ▒▓█████████████▒▓
                   ▒▒▓▓▓▓▓▓▓▓▓▓▓▒▓
   
    _      ____   ____   _____   __  __   ____   _    __   __                                                                                                                                                                                                                                                                                                                                                               
   / \    / ___| / ___| | ____| |  \/  | | __ ) | |   \ \ / /                                                                                                                                                                                                                                                                                                                                                               
  / _ \   \___ \ \___ \ |  _|   | |\/| | |  _ \ | |    \ V /                                                                                                                                                                                                                                                                                                                                                                
 / ___ \ _ ___) | ___) || |___ _| |  | |_| |_) || |___ _| |                                                                                                                                                                                                                                                                                                                                                                 
/_/   \_(_)____(_)____(_)_____(_)_|  |_(_)____(_)_____(_)_|                                                                                                                                                                                                                                                                                                                                                                 
    _         _                        _           _   ____                              _     _               ____            _                    __              _____        __                                         _       __  __           _                _   _                 ____            _        _                         ___     _      __   __      _ _     _        _ _           _   _             
   / \  _   _| |_ ___  _ __ ___   __ _| |_ ___  __| | / ___| _   _ _ __   ___ _ ____   _(_)___(_) ___  _ __   / ___| _   _ ___| |_ ___ _ __ ___    / _| ___  _ __  | ____|_ __  / _| ___  _ __ ___ ___ _ __ ___   ___ _ __ | |_    |  \/  | ___   __| | ___ _ __ __ _| |_(_) ___  _ __     | __ )  __ _ ___(_) ___  | |    ___   __ _ ___     ( _ )   | | ____\ \ / /   __| (_)___| |_ _ __(_) |__  _   _| |_(_) ___  _ __  
  / _ \| | | | __/ _ \| '_ ` _ \ / _` | __/ _ \/ _` | \___ \| | | | '_ \ / _ \ '__\ \ / / / __| |/ _ \| '_ \  \___ \| | | / __| __/ _ \ '_ ` _ \  | |_ / _ \| '__| |  _| | '_ \| |_ / _ \| '__/ __/ _ \ '_ ` _ \ / _ \ '_ \| __|   | |\/| |/ _ \ / _` |/ _ \ '__/ _` | __| |/ _ \| '_ \    |  _ \ / _` / __| |/ __| | |   / _ \ / _` / __|    / _ \/\ | |/ / _ \ V /   / _` | / __| __| '__| | '_ \| | | | __| |/ _ \| '_ \ 
 / ___ \ |_| | || (_) | | | | | | (_| | ||  __/ (_| |  ___) | |_| | |_) |  __/ |   \ V /| \__ \ | (_) | | | |  ___) | |_| \__ \ ||  __/ | | | | | |  _| (_) | |    | |___| | | |  _| (_) | | | (_|  __/ | | | | |  __/ | | | |_ _  | |  | | (_) | (_| |  __/ | | (_| | |_| | (_) | | | |_  | |_) | (_| \__ \ | (__  | |__| (_) | (_| \__ \_  | (_>  < |   <  __/| |   | (_| | \__ \ |_| |  | | |_) | |_| | |_| | (_) | | | |
/_/   \_\__,_|\__\___/|_| |_| |_|\__,_|\__\___|\__,_| |____/ \__,_| .__/ \___|_|    \_/ |_|___/_|\___/|_| |_| |____/ \__, |___/\__\___|_| |_| |_| |_|  \___/|_|    |_____|_| |_|_|  \___/|_|  \___\___|_| |_| |_|\___|_| |_|\__( ) |_|  |_|\___/ \__,_|\___|_|  \__,_|\__|_|\___/|_| |_( ) |____/ \__,_|___/_|\___| |_____\___/ \__, |___( )  \___/\/ |_|\_\___||_|    \__,_|_|___/\__|_|  |_|_.__/ \__,_|\__|_|\___/|_| |_|
                                                                  |_|                                                |___/                                                                                                     |/                                                      |/                                       |___/    |/                                                                                                                                                                    
'''
import json
import mysql.connector
import sys
import threading
import time
from ASSEMBLY_bot_files.ASSEMBLY_botSettings import *
from ASSEMBLY_bot_files._botClass import AssemblyBot
import ASSEMBLY_bot_files.services.autoNameApproval as name_approval

MODULE_NAME = "[ASSEMBLY_bot_core]"

def check_for_offenses():
    '''
    Makes a list of users with offenses that require moderator attention.

    Parameters:
        None

    Returns:
        users_to_report (dict): A dictionary of users with offenses that require moderator attention.
        Example structure:
        {
            "user_discord_uuid_1": [
                {
                    "timestamp": 1736137903,
                    "type": "name",
                    "offense": "Generated offense for testing",
                    "action-taken": "Renamed",
                    "mod-notified": False
                },
                {
                    "timestamp": 1736137904,
                    "type": "chat",
                    "offense": "Inappropriate language",
                    "action-taken": "None",
                    "mod-notified": False
                }
            ],
            "user_discord_uuid_2": [
                {
                    "timestamp": 1736137910,
                    "type": "chat",
                    "offense": "Spamming",
                    "action-taken": "None",
                    "mod-notified": False
                }
            ]
        }
    '''
    
    # Connect to the database
    try:
        db_connection = mysql.connector.connect(**dbConfig)
    except mysql.connector.Error as err:  
        print(f"{MODULE_NAME}: ERROR: {err}")
        return None
    
    # Get all users with a report
    cursor = db_connection.cursor(dictionary=True)
    cursor.execute("SELECT notes, discord_uuid FROM play_keys WHERE notes IS NOT NULL AND notes != '' AND discord_uuid IS NOT NULL")
    users = cursor.fetchall()
    
    if not users:
        print(f"{MODULE_NAME}: WARNING: No users with offenses found")

        cursor.close()
        db_connection.close()

        return None
    
    users_to_report = {}
    
    # Loop through each user and check their offenses
    for user in users:
        discord_uuid = user["discord_uuid"]
        user_report = json.loads(user["notes"])

        users_to_report[discord_uuid] = []
        
        # Go through each offense and check if a mod has been notified for it
        for offense in user_report.get("offenses", []):
            if offense["mod-notified"] == False:
                users_to_report[discord_uuid].append(offense)

        # If number of offenses is less than the threshold, remove the user from the report list
        if len(users_to_report[discord_uuid]) < OFFENSE_THRESHOLD:
            # Remove user from being reported
            del users_to_report[discord_uuid]
    
    cursor.close()
    db_connection.close()

    return users_to_report

#------------------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------------------

if __name__ == "__main__":
    
    dbConfig = {
        'host': DATABASE_IP,
        'user': DATABASE_USER,
        'password': DATABASE_PASS,
        'database': DATABASE_NAME
    }

    dbConfigBlu = {
        'host': DATABASE_IP_BLU,
        'user': DATABASE_USER_BLU,
        'password': DATABASE_PASS_BLU,
        'database': DATABASE_NAME_BLU
    }

    # TEMPORARY for testing purposes
    # add_offenses_to_random_user(4)

    AssemblyBotInstance = AssemblyBot(DISCORD_TOKEN, dbConfig, dbConfigBlu)

    threads = []

    if ENABLE_BOT:
        print(MODULE_NAME + ": Starting Discord bot...")

        # Start the discord bot in a separate thread
        bot_thread = threading.Thread(target=AssemblyBotInstance.start_discord_bot)
        bot_thread.start()
        threads.append(
            {
            "thread_handle": bot_thread, 
            "thread_target": AssemblyBotInstance.start_discord_bot, 
            "thread_name": "Discord_Bot_Thread", 
            "is_daemon": False})
    
        # Start the migration service in a separate thread
        migration_thread = threading.Thread(target=AssemblyBotInstance._main_migration_loop)
        migration_thread.daemon = True
        migration_thread.start()
        threads.append({
            "thread_handle": migration_thread,
            "thread_target": AssemblyBotInstance._main_migration_loop,
            "thread_name": "Migration_Thread",
            "is_daemon": True
        })
    else:
        print(MODULE_NAME + ": Discord bot is disabled")

    if ENABLE_NAME_APPROVAL:
        print(MODULE_NAME + ": Starting name approval service...")
        # Start the name approval service here
        name_approval_thread = threading.Thread(target=name_approval.main)
        name_approval_thread.daemon = True # Daemonize the thread so it stops when the main thread stops
        name_approval_thread.start()
        threads.append({
            "thread_handle": name_approval_thread, 
            "thread_target": name_approval.main, 
            "thread_name": "name_approval_thread", 
            "is_daemon": True})
    else:
        print(MODULE_NAME + ": Name approval service is disabled")

    if len(threads) == 0:
        print(MODULE_NAME + ": ERROR: No systems enabled! See ASSEMBLY_botSettings.py\n Exiting...")
        sys.exit(1)
    
    '''
    Start Periodic
    '''
    task_check_target = 0
    offense_report_target = 0
    
    while True:
        
        # Run offense report check
        if time.time() > offense_report_target:
          
            if ENABLE_NAME_APPROVAL and ENABLE_BOT and TRACK_OFFENSES:
                print(MODULE_NAME + ": Checking for offenses...")
                users_to_report = check_for_offenses()

                if users_to_report:
                    AssemblyBotInstance.report_user_offenses(users_to_report)
                else:
                    print(MODULE_NAME + ": No offenses to report")

            offense_report_target = time.time() + OFFENSE_REPORT_FREQ

        # Check if any threads are dead and restart them
        if time.time() > task_check_target:
            for thread in threads:
                if not thread["thread_handle"].is_alive():
                    print(MODULE_NAME + ": WARNING: Thread " + str(thread["thread_name"]) + " is dead, restarting...")
                    new_thread = threading.Thread(target=thread["thread_target"])
                    new_thread.daemon = thread["is_daemon"]
                    new_thread.start()
                    thread["thread_handle"] = new_thread
                    print(MODULE_NAME + ": Thread " + str(thread["thread_name"]) + " restarted successfully")
            
            task_check_target = time.time() + TASK_CHECK_FREQ

        # Sleep for a while before checking again
        time.sleep(PERIODIC_FREQUENCY)


'''
setup:

'''
    

'''
User Record structure:

{
    "notes":
    [
        {
            "timestamp": 1736137903,
            "note": ""
        },
    ],
    "offenses":
    [
        {
            "timestamp": 1736137903,
            "type": "name",
            "offense": "",
            "action-taken": "Renamed"
            "mod-notified": false
        },
        {
            "timestamp": 1736137903,
            "type": "chat",
            "offense": "",
            "action-taken": "None",
            "mod-notified": false
        }
    ],
    "warnings":
    [
        {
            "timestamp": 1736137903,
            "reason": ""
        }
    ]
}
'''
